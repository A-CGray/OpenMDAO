
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<script type="text/javascript">
    <tabulator_src>
</script>
<script type="text/javascript">
        <d3_src>
</script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<script>
    var data = <scaling_data>;
</script>
<style>
    <tabulator_style>
    div.tooltip {
        position: absolute;
        text-align: center;
        width: 120px;
        height: 28px;
        padding: 2px;
        font: 12px sans-serif;
        background: lightsteelblue;
        border: 0px;
        border-radius: 8px;
        pointer-events: none;
    }
</style>
</head>
<body>

<h1 id="scaling_title"></h1>
    <h2>Design Variables</h2>
    <div id="dv-table"></div>
    <h2>Constraints</h2>
    <div id="con-table"></div>
    <h2>Objectives</h2>
    <div id="obj-table"></div>
    <div id="jac_div"></div>
<script type="text/javascript">

var dv_tabledata = data.dv_table;
var con_tabledata = data.con_table;
var obj_tabledata = data.obj_table;
var jac_data = data.mat_list;
var jac_norm_data = data.var_mat_list;
var wrtVars = data.wrtlabels;
var ofVars = data.oflabels;

document.title = data.title;
document.getElementById("scaling_title").innerHTML = data.title

var d3_format = d3.format(".6~g");

var arr_format = function(num) {
    return "| " + d3_format(num) + " |";
}

var val_formatter = function(cell, formatterParams, onRendered) {
    // cell value is actually [value, size]
    let val = cell.getValue();
    if (val[1] > 1) {
        return arr_format(val[0]);
    }
    if (val[0] == "") {
        return "";
    }
    return d3_format(val[0]);
};


var val_sorter = function(a, b, aRow, bRow, column, dir, sorterParams) {
    if (a == "") {
        a = [-1e99, 0];
    }
    if (b == "") {
        b = [-1e99, 0];
    }
    return a[0] - b[0];
}


var numrow = function(title, field) {
    return {title:title, field:field, hozAlign:"right", visible:true, headerFilter:false, formatter:val_formatter, sorter:val_sorter}
}


var dvtable =
    new Tabulator("#dv-table", {
        // set height of table (in CSS or here), this enables the Virtual DOM and
        // improves render speed dramatically (can be any valid css height value)
        // height: 650,
        dataTree:true,
        dataTreeStartExpanded:false,
        data:dv_tabledata, //assign data to table
        layout:"fitDataFill", //"fitColumns", "fitDataFill",
        columns:[ //Define Table Columns
            {title: "name", field:"name", hozAlign:"left", headerFilter:false, visible:true,},
            {title: "size", field:"size", hozAlign:"center", headerFilter:false, visible:true,},
            {title: "index", field:"index", hozAlign:"center", headerFilter:false, visible:true,},
            {title: "Driver", headerHozAlign: "center", columns: [
                numrow("value", "driver_val"),
                {title: "units", field:"driver_units", hozAlign:"center", headerFilter:false, visible:true, headerSort:false,},
            ]},
            {title: "Model", headerHozAlign: "center", columns: [
                numrow("value", "model_val"),
                {title: "units", field:"model_units", hozAlign:"center", headerFilter:false, visible:true, headerSort:false,},
            ]},
            numrow("ref", "ref"),
            numrow("ref0", "ref0"),
            numrow("scaler", "scaler"),
            numrow("adder", "adder"),
            numrow("upper", "upper"),
            numrow("lower", "lower"),
        ],
    });


var contable =
    new Tabulator("#con-table", {
        // set height of table (in CSS or here), this enables the Virtual DOM and
        // improves render speed dramatically (can be any valid css height value)
        // height: 650,
        dataTree:true,
        dataTreeStartExpanded:false,
        data:con_tabledata, //assign data to table
        layout:"fitDataFill", //"fitColumns", "fitDataFill",
        columns: [ //Define Table Columns
            {title: "name", field:"name", hozAlign:"left", headerFilter:false, visible:true,},
            {title: "size", field:"size", hozAlign:"center", headerFilter:false, visible:true,},
            {title: "index", field:"index", hozAlign:"center", headerFilter:false, visible:true,},
            {title: "Driver", headerHozAlign: "center", columns: [
                numrow("value", "driver_val"),
                {title: "units", field:"driver_units", hozAlign:"center", headerFilter:false, visible:true, headerSort:false,},
            ]},
            {title: "Model", headerHozAlign: "center", columns: [
                numrow("value", "model_val"),
                {title: "units", field:"model_units", hozAlign:"center", headerFilter:false, visible:true, headerSort:false,},
            ]},
            numrow("ref", "ref"),
            numrow("ref0", "ref0"),
            numrow("scaler", "scaler"),
            numrow("adder", "adder"),
            numrow("upper", "upper"),
            numrow("lower", "lower"),
            numrow("equals", "equals"),
            {title: "linear", field:"linear", hozAlign:"center", visible:true, formatter:"tickCross",
            formatterParams: {
                crossElement: false,  // gets rid of 'x' elements so only check marks show
            }, headerFilter:false,},
        ],
    });


var objtable =
    new Tabulator("#obj-table", {
        // set height of table (in CSS or here), this enables the Virtual DOM and
        // improves render speed dramatically (can be any valid css height value)
        // height: 650,
        dataTree:true,
        dataTreeStartExpanded:false,
        data:obj_tabledata, //assign data to table
        layout:"fitColumns", //"fitDataFill",
        columns:[ //Define Table Columns
            {title: "name", field:"name", hozAlign:"left", visible:true, headerFilter:false,},
            {title: "size", field:"size", hozAlign:"center", visible:true, headerFilter:false,},
            {title: "index", field:"index", hozAlign:"center", headerFilter:false, visible:true,},
            {title: "Driver", headerHozAlign: "center", columns: [
                numrow("value", "driver_val"),
                {title: "units", field:"driver_units", hozAlign:"center", headerFilter:false, visible:true,headerSort:false,},
            ]},
            {title: "Model", headerHozAlign: "center", columns: [
                numrow("value", "model_val"),
                {title: "units", field:"model_units", hozAlign:"center", headerFilter:false, visible:true, headerSort:false,},
            ]},
            numrow("ref", "ref"),
            numrow("ref0", "ref0"),
            numrow("scaler", "scaler"),
            numrow("adder", "adder"),
        ],
    });


var viewport_width = document.documentElement.clientWidth * .95;
var viewport_height = document.documentElement.clientHeight * .75;

var leftmargin = d3.max(ofVars, s => s.length) * 5.5;
var bottommargin = d3.max(wrtVars, s => s.length) * 6;

// set the dimensions and margins of the graph
var margin = {top: 30, right: 30, bottom: bottommargin, left: leftmargin };
var width = viewport_width - margin.left - margin.right;
var height = viewport_height - margin.top - margin.bottom;

var w = width + margin.left + margin.right;
var h = height + margin.top + margin.bottom;

var jac_parent = d3.select("#jac_div")
    .append("h2")
    .html("Jacobian Info")

// append the svg object to the body of the page
var svg = d3.select("#jac_div")
    .append("div")
    .attr("id", "norm-jac")
    .append("svg")
    .attr("viewBox", "0 0 " + w + " " + h)
    .attr("preserveAspectRatio", "xMidYMid meet")
    .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

// Build X scales and axis:
var x = d3.scaleBand()
    .range([0, width])
    .domain(wrtVars)
    .padding(0.01);

svg.append("g")
    .attr("transform", "translate(0," + height + ")")
    .call(d3.axisBottom(x))
        .selectAll("text")
        .style("text-anchor", "start")
        .attr("dx", ".8em")
        .attr("dy", "-.5em")
        .attr("transform", "rotate(90)");

// Build Y scales and axis:
var y = d3.scaleBand()
    .range([0, height])
    .domain(ofVars)
    .padding(0.01);

svg.append("g")
    .call(d3.axisLeft(y));

// create a tooltip
var tooltip = d3.select("#norm-jac")
    .append("div")
    .style("opacity", 0)
    .attr("class", "tooltip");

var mouseover = function(event, d) {
    event.stopPropagation();
    if (d.value == null) {
        return;
    }
    tooltip.style("opacity", 1);
    d3.select(this)
        .style("stroke", "black")
        .style("opacity", 1);
}

var mousemove = function(event, d) {
    event.stopPropagation();
    if (d.value == null) {
        return;
    }
    tooltip
        .html(d.value)
        .style("left", event.pageX + 10 + "px")
        .style("top", event.pageY - 15 + "px");
}

var mouseleave = function(event, d) {
    event.stopPropagation();
    if (d.value == null) {
        return;
    }
    tooltip.style("opacity", 0)
    d3.select(this)
        .style("stroke", "none")
        .style("opacity", 0.8);
}

var array = [];
for (lst of jac_norm_data) {
    array.push({ 'value': lst[2], 'group': wrtVars[lst[1]], 'variable': ofVars[lst[0]] });
}
// for (let i = 0; i < ofVars.length; i++) {
//     for (let j = 0; j < wrtVars.length; j ++) {
//         array.push({ 'value': jac_norm_data[i][j], 'group': wrtVars[j], 'variable': ofVars[i] });
//     }
// }

var maxcolor = Math.abs(d3.max(array, s => s.value));

// Build color scale
var subjacColor = d3.scaleDiverging()
    .interpolator(d3.interpolateRdYlBu)
    .domain([-maxcolor, 0, maxcolor]);

function donothing(event, d) {
    console.print("do nothing");
}

svg.selectAll()
    .data(array, function (d) { return d.group + ':' + d.variable; })
    .enter()
    .append("rect")
    .attr("x", function (d) { return x(d.group) })
    .attr("y", function (d) { return y(d.variable) })
    .attr("width", x.bandwidth())
    .attr("height", y.bandwidth())
    .style("fill", d => d.value == null ? "gray" : subjacColor(d.value))
    .on("mouseover", mouseover)
    .on("mousemove", mousemove)
    .on("mouseleave", mouseleave);

</script>
</body>
</html>
